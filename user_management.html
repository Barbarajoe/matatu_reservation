<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOM8d7xj1z5l5e5e5e5e5e5e5e5e5e5e5e5e5" crossorigin="anonymous">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="Logo.jpg" width="120" alt="Matatu System">
            <span>Admin: <?php echo $_SESSION['username']; ?></span>
        </div>
        <ul>
            <li><a href="administrator_home.html">Dashboard</a></li>
            <li><a href="user_management.html">User Management</a></li>
            <li><a href="system_reports.html">System Reports</a></li>
            <li><a href="audit_logs.html">Audit Logs</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="logout.php">Logout</a></li>
        </ul>
    </nav>

    <?php include 'navbar.php'; ?>
    
    <div class="container">
        <div class="stats-container">
            <div class="stat-card">
                <h3>Total Users</h3>
                <p id="total-users">0</p>
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-card">
                <h3>Active Today</h3>
                <p id="active-users">0</p>
                <i class="fas fa-user-check"></i>
            </div>
        </div>

        <!-- User Controls -->
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search users...">
                <button onclick="searchUsers()" title="Search"><i class="fas fa-search"></i></button>
            </div>
            <button class="btn-primary" onclick="showAddUserModal()">
                <i class="fas fa-user-plus"></i> Add New User
            </button>
        </div>

        <!-- User Table -->
        <h2>User Accounts</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th onclick="sortUsers('username')">Username <i class="fas fa-sort"></i></th>
                    <th onclick="sortUsers('email')">Email <i class="fas fa-sort"></i></th>
                    <th onclick="sortUsers('role')">Role <i class="fas fa-sort"></i></th>
                    <th>Status</th>
                    <th>Registered</th>
                    <th>Actions</th>
                </tr>
            </thead>
</table>
                <!-- Data loaded via AJAX -->
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination">
            <button id="prev-page" onclick="changePage(-1)" title="Previous Page"><i class="fas fa-chevron-left"></i></button>
            <span id="current-page">1</span>
            <button id="next-page" onclick="changePage(1)" title="Next Page"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Add New User</h3>
            <form id="add-user-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="new-username" title="Enter username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="new-email" title="Enter email" placeholder="Enter email" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="new-role" title="Select user role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="driver">Driver</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Create User</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Edit User</h3>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="edit-username" title="Enter username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="edit-email" title="Enter email" placeholder="Enter email" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="edit-role" title="Select user role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="driver">Driver</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>
        

        
            
    
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentSort = 'username';
        let sortOrder = 'asc';

        // Initial load
        fetchUsers();

        function fetchUsers() {
            const params = new URLSearchParams({
                page: currentPage,
                sort: currentSort,
                order: sortOrder,
                search: document.getElementById('search-input').value
            });

            fetch(`getusers.php?${params}`)
                .then(response => response.json())
                .then(data => {
                    populateTable(data.users);
                    updatePagination(data.total, data.per_page);
                    updateStats(data.stats);
                })
                .catch(error => showToast('Error loading users', 'error'));
        }

        function populateTable(users) {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td><span class="status ${user.status}">${user.status}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-edit" onclick="showEditModal(${user.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePagination(total, perPage) {
            totalPages = Math.ceil(total / perPage);
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function updateStats(stats) {
            document.getElementById('total-users').textContent = stats.total;
            document.getElementById('active-users').textContent = stats.active;
        }

        function sortUsers(column) {
            if(currentSort === column) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = column;
                sortOrder = 'asc';
            }
            fetchUsers();
        }

        function changePage(direction) {
            currentPage = Math.max(1, currentPage + direction);
            fetchUsers();
        }

        function searchUsers() {
            currentPage = 1;
            fetchUsers();
        }

        // Add modal functions and form handling
        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'block';
        }

        function showEditModal(userId) {
            fetch(`getuser.php?id=${userId}`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('edit-user-id').value = user.id;
                    document.getElementById('edit-username').value = user.username;
                    document.getElementById('edit-email').value = user.email;
                    document.getElementById('edit-role').value = user.role;
                    document.getElementById('edit-user-modal').style.display = 'block';
                });
        }

        // Add form submission handlers
        document.getElementById('add-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const userData = {
                username: document.getElementById('new-username').value,
                email: document.getElementById('new-email').value,
                role: document.getElementById('new-role').value
            };

            fetch('adduser.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if(response.ok) {
                    fetchUsers();
                    closeModal();
                    showToast('User created successfully', 'success');
                }
            });
        });

        // Similar form handler for edit-user-form

        function deleteUser(userId) {
            if(confirm('Are you sure you want to delete this user?')) {
                fetch(`delete_user.php?id=${userId}`, { method: 'DELETE' })
                    .then(response => {
                        if(response.ok) {
                            fetchUsers();
                            showToast('User deleted successfully', 'success');
                        }
                    });
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = toast.className.replace('show', ''), 3000);
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => 
                modal.style.display = 'none');
        }
    </script>
          
      
  <!-- Footer -->
  <footer class="footer">
    <div class="footer-container">
        <div class="footer-links">
            <ul>
                <li><a href="About_us.html">About Us</a></li>
                <li><a href="Contact.html">Contact</a></li>
                <li><a href="Private_policy.html">Privacy Policy</a></li>
                <li><a href="Terms_of_service.html">Terms of Service</a></li>
            </ul>
        </div>
    
        <div class="footer-copy">
            <p>&copy; 2025 Urban Transit . All rights reserved.</p>
        </div>
    </div>
</footer>

</body>
</html>